#!/bin/bash

KAFKA_LOG_DIR="/var/log/kafka"
KAFKA_HOME="/opt/kafka"
SACLA_VERSION="2.9.2"
KAFKA_VERSION="0.8.1.1"
KAFKA_DIR="$KAFKA_HOME/kafka_$SACLA_VERSION-$KAFKA_VERSION"

get_pid() {
  if [ -f "$KAFKA_HOME/pid" ]; then
    echo $(<"$KAFKA_HOME/pid")
  else
    echo ""
  fi
}

check_sudo() {
  if [ "$EUID" -ne 0 ]
    then echo "Please you need to use 'sudo' to run this command" >&2
    exit 1
  fi
}

start() {
  KAFKA_PID=$(get_pid)
  if [ -z "$KAFKA_PID" ]; then
    echo "starting kafka..."
    nohup "$KAFKA_DIR/bin/kafka-server-start.sh" \
     "$KAFKA_DIR/config/server.properties" > \
     "$KAFKA_LOG_DIR/$(date +%s).log" 2>&1&
    echo $! > "$KAFKA_HOME/pid"
    sleep 2
    echo "kafka(v$KAFKA_VERSION) PID $(<$KAFKA_HOME/pid)"
  else
    echo "Warning: kafka(v$KAFKA_VERSION) is alredy running!" >&2
  fi
}

stop() {
  KAFKA_PID=$(get_pid)
  if [ ! -z $KAFKA_PID ]; then
    kill -15 $KAFKA_PID
    echo "sent a SIGTERM to kafka PID $KAFKA_PID..."
    rm -rf "$KAFKA_HOME/pid"
    sleep 2
    KAFKA_PID=""
  fi
}

status() {
  KAFKA_PID=$(get_pid)
  if [ -z "$KAFKA_PID" ]; then
    echo "kafka(v$KAFKA_VERSION) isn't running"
  else
    echo "kafka(v$KAFKA_VERSION) is running with the PID $KAFKA_PID"
  fi
}

case "$1" in
  start)
    check_sudo
    start
    ;;
  stop)
    check_sudo
    stop
    ;;
  restart)
    check_sudo
    stop
    start
    ;;
  status)
    status
    ;;
  *)
    echo "Usage: start|stop|restart"
    ;;
esac
